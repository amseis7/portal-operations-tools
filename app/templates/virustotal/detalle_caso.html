{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h3 class="mb-0">Caso #{{ caso.id }}: <span class="text-primary">{{ caso.nombre }}</span></h3>
            <small class="text-muted">{{ caso.descripcion }}</small>
        </div>

        <div id="zona-progreso" class="card mb-2 border-info d-none">
            <div class="card-body">
                <h5 class="card-title text-info">
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                    Analizando en segundo plano...
                </h5>
                <div class="progress mt-2" style="height: 25px;">
                    <div id="barra-progreso" class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                        role="progressbar" style="width: 0%;">
                        0%
                    </div>
                </div>
                <div class="text-muted small mt-2">
                    Procesados: <span id="contador-progreso">0/0</span>
                </div>
            </div>
        </div>
        
        <div>
            <form action="{{ url_for('virustotal.analizar_caso', caso_id=caso.id, source=request.args.get('source'), origin_id=request.args.get('origin_id')) }}" method="POST" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="btn btn-warning me-2" onclick="return confirm('¿Ejecutar análisis en VirusTotal para todos los IoCs de este caso?')">
                    <i class="bi bi-play-fill"></i> Ejecutar Análisis
                </button>
            </form>

            <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#modalExportar">
                <i class="bi bi-file-zip"></i> Exportar Bloqueos
            </button>

            <div class="modal fade" id="modalExportar" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-dark text-white">
                            <h5 class="modal-title">Generar Archivos de Bloqueo</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <form action="{{ url_for('virustotal.exportar_zip', caso_id=caso.id, caso_nombre=caso.nombre) }}" method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <div class="modal-body">
                                <p class="small text-muted">Activa las plataformas para las que deseas generar archivos. Se incluirán solo los IoCs que dicha plataforma <strong>NO detectó</strong>.</p>
                                
                                <div class="list-group">
                                    {% for t in templates_export %}
                                    <label class="list-group-item d-flex gap-3 align-items-center">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" name="templates_seleccionados" value="{{ t.id }}" checked style="transform: scale(1.3);">
                                        </div>
                                        
                                        <span class="pt-1 form-checked-content">
                                            <strong>{{ t.nombre_plataforma }}</strong>
                                            <small class="d-block text-muted" style="font-size: 0.8rem;">
                                                Motor VT: {{ t.vt_engine_name }} | Formato: .{{ t.file_extension }}
                                            </small>
                                        </span>
                                    </label>
                                    {% else %}
                                    <div class="alert alert-warning small">
                                        No hay plantillas configuradas. Pide al Administrador que cree una en el menú de configuración.
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-download"></i> Descargar ZIP
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            {# LÓGICA DE NAVEGACIÓN #}
        {% if request.args.get('source') == 'csirt' and request.args.get('origin_id') %}
            
            {# CASO 1: Vienes del CSIRT (Independiente del nombre del caso) #}
            <a href="{{ url_for('csirt.ver_gestion', ticket_id=request.args.get('origin_id')) }}" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left"></i> Volver al Ticket <!--{{ request.args.get('origin_id') }}-->
            </a>

        {% else %}
            
            {# CASO 2: Vienes del Índice de VT o cualquier otro lado #}
            <a href="{{ url_for('virustotal.index') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Volver al Listado
            </a>

        {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-md-3">
            <div class="card shadow-sm mb-4 sticky-top" style="top: 20px; z-index: 1;">
                <div class="card-header bg-dark text-white small fw-bold">
                    <i class="bi bi-plus-circle"></i> Agregar Indicadores
                </div>

                <div class="card-body p-3">
                    <form method="POST" id="formAgregar">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <label class="form-label small fw-bold">Tipo de IoC:</label>
                        <div class="btn-group w-100 mb-3" role="group">
                            <input type="radio" class="btn-check" name="tipo_ioc" id="add_hash" value="hash" checked onchange="validarEntrada()">
                            <label class="btn btn-outline-secondary btn-sm" for="add_hash">Hash</label>

                            <input type="radio" class="btn-check" name="tipo_ioc" id="add_ip" value="ip" onchange="validarEntrada()">
                            <label class="btn btn-outline-secondary btn-sm" for="add_ip">IP</label>

                            <input type="radio" class="btn-check" name="tipo_ioc" id="add_dom" value="dominio" onchange="validarEntrada()">
                            <label class="btn btn-outline-secondary btn-sm" for="add_dom">Dom/Url</label>
                        </div>

                        <label class="form-label small fw-bold">Lista (Uno por línea):</label>
                        <textarea class="form-control font-monospace mb-2 form-control-sm" id="hashes_input" name="hashes_input" rows="8" placeholder="Pegar lista..." required oninput="validarEntrada()"></textarea>
                        
                        <div id="feedback_validacion" class="mb-2 small"></div>

                        <button type="submit" class="btn btn-success w-100 btn-sm" id="btnAgregar">
                            <i class="bi bi-plus-lg"></i> Cargar a la Lista
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card shadow-sm">
                <div class="card-header bg-light small fw-bold">
                    Resultados del Análisis ({{ caso.iocs|length }} IoCs)
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm table-hover mb-0 align-middle">
                        <thead class="table-dark text-nowrap">
                            <tr>
                                <th>Tipo</th>
                                <th>Valor</th>
                                <th class="text-center">Detecciones</th>
                                <th class="text-center">Estado</th>
                                <th class="text-center">Reporte</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ioc in caso.iocs %}
                            <tr>
                                <td><span class="badge bg-light text-dark border">{{ ioc.tipo }}</span></td>
                                
                                <td class="font-monospace small text-truncate" style="max-width: 300px;" title="{{ ioc.valor }}">
                                    {{ ioc.valor }}
                                </td>
                                
                                <td class="text-center">
                                    {% if ioc.vt_last_check %}
                                        {% if ioc.vt_positives > 0 %}
                                            <span class="badge bg-danger">{{ ioc.vt_positives }} / {{ ioc.vt_total }}</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">0 / {{ ioc.vt_total }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted small">-</span>
                                    {% endif %}
                                </td>
                                
                                <td class="text-center">
                                    {% if ioc.vt_last_check %}
                                        {% set motores = ioc.get_motores() %}
                                        
                                        {# CASO 1: DESCONOCIDO (VT no lo tiene) #}
                                        {% if motores.get('ERROR') == 'Not Found in VirusTotal' %}
                                            <span title="Desconocido: VT no tiene este archivo/IP">
                                                <i class="bi bi-question-circle-fill text-secondary fs-5"></i>
                                            </span>
                                        
                                        {# CASO 2: DETECTADO (Confirmado por comunidad) #}
                                        {% elif ioc.vt_positives > 0 %}
                                            <span title="Confirmado: {{ ioc.vt_positives }} motores lo detectan">
                                                <i class="bi bi-bug-fill text-danger fs-5"></i>
                                            </span>
                                        
                                        {# CASO 3: FURTIVO (0 Detecciones, pero sabemos que es malo) #}
                                        {% else %}
                                            <span title="Furtivo: Ningún motor en VT lo detecta (¡Cuidado!)">
                                                <i class="bi bi-exclamation-triangle-fill text-warning fs-5"></i>
                                            </span>
                                        {% endif %}

                                    {% else %}
                                        {% set motores = ioc.get_motores() %}
                                        {% if motores.get('ERROR') %}
                                            <span class="badge bg-danger" title="{{ motores['ERROR'] }}">
                                                <i class="bi bi-exclamation-triangle"></i> Error
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">Pendiente</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                
                                <td class="text-center">
                                    {% if ioc.vt_permalink %}
                                    <a href="{{ ioc.vt_permalink }}" target="_blank" class="btn btn-sm btn-outline-secondary" title="Abrir en VirusTotal">
                                        <i class="bi bi-box-arrow-up-right"></i>
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="5" class="text-center py-5 text-muted">La lista está vacía. Usa el panel izquierdo para agregar IoCs.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function validarEntrada() {
        const tipo = document.querySelector('input[name="tipo_ioc"]:checked').value;
        const input = document.getElementById('hashes_input');
        const feedback = document.getElementById('feedback_validacion');
        const btn = document.getElementById('btnAgregar');
        
        const lineas = input.value.split('\n');
        let validos = 0;
        let invalidos = 0;
        
        // Regex estrictas
        const regexIP = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;
        // Hash: MD5 (32), SHA1 (40), SHA256 (64) - Hexadecimal
        const regexHash = /^[a-fA-F0-9]{32}$|^[a-fA-F0-9]{40}$|^[a-fA-F0-9]{64}$/; 
        // Dominio: Algo.Algo (básico)
        const regexDomain = /^([a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}.*$/; 

        lineas.forEach(linea => {
            linea = linea.trim();
            if (linea === "") return; 

            let esValido = false;
            if (tipo === 'hash') esValido = regexHash.test(linea);
            else if (tipo === 'ip') esValido = regexIP.test(linea);
            else if (tipo === 'dominio') esValido = regexDomain.test(linea);

            if (esValido) validos++;
            else invalidos++;
        });

        if (input.value.trim() === "") {
            feedback.innerHTML = "";
            btn.disabled = false;
        } else if (invalidos > 0) {
            feedback.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-circle"></i> Hay <strong>${invalidos}</strong> líneas que no parecen ser ${tipo.toUpperCase()}.</span>`;
            btn.disabled = true; // Bloqueamos el botón si hay errores
        } else {
            feedback.innerHTML = `<span class="text-success"><i class="bi bi-check-circle"></i> ${validos} IoCs válidos.</span>`;
            btn.disabled = false;
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        // Obtenemos el ID sin comillas que den error en el editor
        var casoId = "{{ caso.id }}";
        
        var zonaProgreso = document.getElementById('zona-progreso');
        var barra = document.getElementById('barra-progreso');
        var contador = document.getElementById('contador-progreso');
        var intervalo = null;

        function consultarEstado() {
            fetch('/virustotal/api/estado_caso/' + casoId)
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    var pct = data.porcentaje;
                    barra.style.width = pct + "%";
                    barra.innerText = pct + "%";
                    contador.innerText = data.procesados + " / " + data.total;

                    // Si sigue procesando, mostramos (por si estaba oculto)
                    if (data.estado === 'procesando') {
                        zonaProgreso.classList.remove('d-none');
                    } else if (data.estado === 'completado' && pct >= 100) {
                        if (!zonaProgreso.classList.contains('d-none')) {
                            barra.classList.remove('bg-info');
                            barra.classList.add('bg-success');
                            barra.innerText = "¡Finalizado!";
                            // Recargar la página limpia (sin el parámetro analyzing)
                            setTimeout(function() { 
                                // Quitamos el parámetro analyzing de la URL antes de recargar
                                var url = new URL(window.location.href);
                                url.searchParams.delete('analyzing');
                                window.location.href = url.toString();
                            }, 1500);
                        }
                    }
                })
                .catch(function(err) { console.error("Error polling:", err); });
        }

        // --- LÓGICA CLAVE: ¿DEBO MOSTRAR LA BARRA? ---
        var urlParams = new URLSearchParams(window.location.search);
        var vieneDeBoton = urlParams.has('analyzing');

        fetch('/virustotal/api/estado_caso/' + casoId)
            .then(function(r) { return r.json(); })
            .then(function(d) {                
                //var servidorTrabajando = (d.estado === 'procesando');

                if (vieneDeBoton){// || servidorTrabajando) {
                    zonaProgreso.classList.remove('d-none');
                    intervalo = setInterval(consultarEstado, 3000); // Iniciar Polling
                }
                else{
                    fetch('/virustotal/api/estado_caso/' + casoId)
                    .then(r => r.json())
                    .then(d => console.log("Estado servidor:", d));
                }
            });
    });
</script>
{% endblock %}