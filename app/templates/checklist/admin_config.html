{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-cogs"></i> Configuración de Servicios</h2>
            <p class="text-muted">Gestiona las credenciales de tus monitores externos.</p>
        </div>
        <div>
            <a href="{{ url_for('checklist.forzar_actualizacion') }}" class="btn btn-warning me-2">
                <i class="fas fa-sync-alt"></i> Forzar Actualización
            </a>
            <a href="{{ url_for('checklist.index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver al Dashboard
            </a>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
             {{ message }}
             <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="row">
        <div class="col-md-5">
            <div class="card shadow">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0" id="formTitle">Nuevo Servicio</h5>
                    <button class="btn btn-sm btn-light text-primary" id="btnCancelEdit" style="display:none;" onclick="resetForm()">
                        Cancelar
                    </button>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('checklist.guardar_servicio') }}" id="configForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        
                        <input type="hidden" name="service_id" id="service_id" value="">

                        <div class="mb-3">
                            <label class="form-label fw-bold">Nombre del Cliente / Servicio</label>
                            <input type="text" class="form-control" name="nombre_cliente" id="nombre_cliente" 
                                   placeholder="Ej: Banco Estado - FortiEDR" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Tecnología</label>
                            <select class="form-select" name="plugin_slug" id="pluginSelect" onchange="renderFields()" required>
                                <option value="" disabled selected>-- Seleccionar Plugin --</option>
                                {% for p in plugins %}
                                <option value="{{ p.slug }}">{{ p.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <hr>

                        <div id="dynamicFields" class="mb-3">
                            <p class="text-muted small text-center">Selecciona una tecnología para ver las opciones.</p>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-secondary" id="btnTest" onclick="probarConexion()">
                                <i class="fas fa-plug"></i> Probar Conexión
                            </button>
                            
                            <button type="submit" class="btn btn-success" id="btnGuardar">
                                <i class="fas fa-save"></i> Guardar Configuración
                            </button>
                        </div>
                        
                        <div id="testResult" class="mt-2 text-center" style="display:none;"></div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Servicios Activos</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for svc in servicios %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0 fw-bold">{{ svc.nombre_cliente }}</h6>
                                    <small class="text-muted">
                                        {% for p in plugins %}
                                            {% if p.slug == svc.tipo_tecnologia %}
                                                {{ p.nombre }}
                                            {% endif %}
                                        {% endfor %}
                                    </small>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="cargarEdicion('{{ svc.id }}', '{{ svc.tipo_tecnologia }}', '{{ svc.nombre_cliente }}')">
                                        Editar
                                    </button>
                                    
                                    <form action="{{ url_for('checklist.eliminar_servicio', id=svc.id) }}" method="POST" 
                                          onsubmit="return confirm('¿Estás seguro de eliminar este servicio?');" style="margin:0;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <button type="submit" class="btn btn-sm btn-danger">
                                            Borrar
                                        </button>
                                    </form>
                                </div>
                            </div>
                        {% else %}
                            <div class="p-4 text-center text-muted">
                                No hay servicios configurados.
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Diccionarios limpios desde Python
    const pluginDefs = {{ plugin_defs_js|tojson }};
    const savedConfigs = {{ saved_configs|tojson }}; 
    const csrfToken = "{{ csrf_token() }}"; // Token para usar en Fetch/AJAX

    function renderFields(dataValues = null) {
        const slug = document.getElementById('pluginSelect').value;
        const container = document.getElementById('dynamicFields');
        container.innerHTML = ''; 

        if (!slug || !pluginDefs[slug]) return;

        const fields = pluginDefs[slug];
        fields.forEach(field => {
            const wrapper = document.createElement('div');
            wrapper.className = 'mb-3';
            
            const label = document.createElement('label');
            label.className = 'form-label';
            label.innerText = field.label;
            
            const input = document.createElement('input');
            input.type = field.type; 
            input.name = field.name;      
            input.id = 'field_' + field.name; // ID para buscarlo fácil con JS
            input.className = 'form-control';
            input.placeholder = field.placeholder || '';

            if (dataValues && dataValues[field.name]) {
                if (field.type === 'password') {
                    input.placeholder = "●●●●●● (Dejar vacío para mantener)";
                } else {
                    input.value = dataValues[field.name];
                }
            }
            wrapper.appendChild(label);
            wrapper.appendChild(input);
            container.appendChild(wrapper);
        });
    }

    function cargarEdicion(id, slug, nombre) {
        document.getElementById('service_id').value = id;
        document.getElementById('nombre_cliente').value = nombre;
        document.getElementById('pluginSelect').value = slug;

        const configData = savedConfigs[id] || {};
        renderFields(configData);

        // UI Updates
        document.getElementById('formTitle').innerText = "Editando: " + nombre;
        document.getElementById('btnGuardar').className = "btn btn-warning";
        document.getElementById('btnGuardar').innerText = "Actualizar Servicio";
        document.getElementById('btnCancelEdit').style.display = 'block';
        document.getElementById('testResult').style.display = 'none';
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetForm() {
        document.getElementById('configForm').reset();
        document.getElementById('service_id').value = "";
        document.getElementById('dynamicFields').innerHTML = '<p class="text-muted small text-center">Selecciona una tecnología...</p>';
        
        document.getElementById('formTitle').innerText = "Nuevo Servicio";
        document.getElementById('btnGuardar').className = "btn btn-success";
        document.getElementById('btnGuardar').innerText = "Guardar Configuración";
        document.getElementById('btnCancelEdit').style.display = 'none';
        document.getElementById('testResult').style.display = 'none';
    }

    // --- FUNCIÓN AJAX PARA PROBAR CONEXIÓN ---
    function probarConexion() {
        const slug = document.getElementById('pluginSelect').value;
        const resultDiv = document.getElementById('testResult');
        
        if (!slug) {
            alert("Selecciona primero una tecnología.");
            return;
        }

        // 1. Recopilar datos del formulario manualmente
        const fields = pluginDefs[slug];
        let credentials = {};
        
        fields.forEach(f => {
            const val = document.getElementById('field_' + f.name).value;
            credentials[f.name] = val;
        });

        // UI de "Cargando..."
        resultDiv.style.display = 'block';
        resultDiv.className = 'alert alert-info mt-2';
        resultDiv.innerText = "Probando conexión... espera un momento.";

        // 2. Enviar petición POST a Flask
        fetch("{{ url_for('checklist.api_test_connection') }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken // Importante pasar el token aquí
            },
            body: JSON.stringify({
                plugin_slug: slug,
                credentials: credentials
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultDiv.className = 'alert alert-success mt-2';
                resultDiv.innerText = "✅ Éxito: " + data.message;
            } else {
                resultDiv.className = 'alert alert-danger mt-2';
                resultDiv.innerText = "❌ Error: " + data.message;
            }
        })
        .catch(error => {
            resultDiv.className = 'alert alert-danger mt-2';
            resultDiv.innerText = "Error de red: " + error;
        });
    }
</script>
{% endblock %}