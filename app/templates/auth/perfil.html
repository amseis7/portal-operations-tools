{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-person-badge"></i> Mi Perfil</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <h6 class="text-primary border-bottom pb-2 mb-3">Información Personal</h6>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Nombre de Usuario (Login)</label>
                            <input type="text" class="form-control" value="{{ current_user.username }}" disabled bg-light>
                            <div class="form-text">El nombre de usuario no se puede cambiar.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nombre Completo</label>
                            <input type="text" name="nombre_completo" class="form-control" value="{{ request.form.get('nombre_completo', current_user.nombre_completo) }}" required>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Correo Electrónico</label>
                        <input type="email" name="email" class="form-control" value="{{ request.form.get('email', current_user.email) }}" required>
                    </div>

                    <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">Integraciones Externas</h6>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">VirusTotal API Key</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-key"></i></span>
                            <input type="text" name="vt_key" class="form-control font-monospace" 
                                   placeholder="Pega tu API Key nueva aquí" 
                                   value="{% if current_user.virustotal_api_key %}********************************{% endif %}">
                        </div>
                        <div class="form-text">
                            {% if current_user.virustotal_api_key %}
                                <span class="text-success"><i class="bi bi-check-circle"></i> Tienes una API Key configurada y segura.</span>
                                Para cambiarla, borra los asteriscos y pega la nueva.
                            {% else %}
                                No tienes API Key configurada.
                            {% endif %}
                        </div>
                        
                        <div class="form-text">
                            Necesaria para analizar IoCs. Puedes obtener una gratis en <a href="https://www.virustotal.com/" target="_blank">virustotal.com</a>.
                        </div>
                    </div>

                    <div class="card mb-4 shadow-sm border-info">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
        <span><i class="bi bi-speedometer2"></i> Estado de la API Key</span>
        
        {% if current_user.virustotal_api_key %}
            <a href="{{ url_for('auth.perfil', ver_cuota=1) }}" class="btn btn-sm btn-light text-info fw-bold">
                <i class="bi bi-arrow-clockwise"></i> Verificar Consumo
            </a>
        {% else %}
            <span class="badge bg-warning text-dark">Sin Key</span>
        {% endif %}
    </div>
    
    <div class="card-body">
        {% if datos_cuota %}
        <div class="row text-center">
            <div class="col-4">
                <h6 class="text-muted">Por Hora</h6>
                <h4 class="fw-bold text-secondary">{{ datos_cuota.hora_usado }} / {{ datos_cuota.hora_limite }}</h4>
            </div>
            <div class="col-4">
                <h6 class="text-muted">Diario</h6>
                <h4 class="fw-bold text-primary">{{ datos_cuota.diario_usado }} / {{ datos_cuota.diario_limite }}</h4>
            </div>
            <div class="col-4 border-start border-end">
                <h6 class="text-muted">Mensual</h6>
                <h4 class="fw-bold text-success">{{ datos_cuota.mensual_usado }} / {{ datos_cuota.mensual_limite }}</h4>
            </div>
        </div>
        <div class="mt-3 alert alert-light border small text-center mb-0">
            <i class="bi bi-info-circle"></i> Estos valores son reportados directamente por VirusTotal.
        </div>
    {% else %}
        <p class="text-center text-muted my-3">
            <i class="bi bi-cloud-slash fs-4 d-block mb-2"></i>
            Haz clic en "Verificar Consumo" para ver tus límites actuales.<br>
            <small>(Esta acción consume 1 consulta de tu cuota)</small>
        </p>
    {% endif %}
</div>
</div>

                    <h6 class="text-primary border-bottom pb-2 mb-3">Seguridad (Dejar en blanco si no desea cambiar)</h6>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Contraseña Actual</label>
                            <input type="password" name="current_password" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Nueva Contraseña</label>
                            <input type="password" name="new_password" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Confirmar Nueva</label>
                            <input type="password" name="confirm_password" class="form-control">
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary me-md-2">Cancelar</a>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}